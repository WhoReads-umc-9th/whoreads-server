name: CD Production

on:
  push:
    branches: [main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/whoreads
  DOCKER_TAG: prod-${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:prod-latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy Nginx template to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "nginx/default.conf.template"
          target: "~/whoreads/"
          strip_components: 0

      - name: Deploy to EC2 (Production)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            # ========================================
            # 변수 설정
            # ========================================
            DEPLOY_DIR="$HOME/whoreads"
            NETWORK_NAME="whoreads-network"
            NGINX_CONTAINER="whoreads-nginx"
            NGINX_CONF="$DEPLOY_DIR/nginx/conf.d/default.conf"
            DOCKER_IMAGE="${{ secrets.DOCKER_USERNAME }}/whoreads:prod-latest"

            # ========================================
            # 1. 기초 공사: 디렉토리 및 네트워크 확인/생성
            # ========================================
            echo "=== Step 1: Infrastructure Setup ==="

            # 배포 디렉토리 생성 (없으면)
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Creating deploy directory: $DEPLOY_DIR"
              mkdir -p "$DEPLOY_DIR"
              mkdir -p "$DEPLOY_DIR/nginx/conf.d"
            fi

            # Nginx 설정 파일이 없으면 템플릿에서 생성
            NGINX_TEMPLATE="$DEPLOY_DIR/nginx/default.conf.template"
            if [ ! -f "$NGINX_CONF" ] && [ -f "$NGINX_TEMPLATE" ]; then
              echo "Creating nginx config from template..."
              cp "$NGINX_TEMPLATE" "$NGINX_CONF"
            fi

            # Docker 네트워크 생성 (없으면)
            if ! docker network inspect "$NETWORK_NAME" >/dev/null 2>&1; then
              echo "Creating docker network: $NETWORK_NAME"
              docker network create "$NETWORK_NAME"
            else
              echo "Docker network already exists: $NETWORK_NAME"
            fi

            cd "$DEPLOY_DIR"

            # ========================================
            # 2. 현재 상태 확인 및 Blue/Green 결정
            # ========================================
            echo "=== Step 2: Determine Blue/Green ==="

            CURRENT=$(docker ps --filter "name=whoreads-prod" --format "{{.Names}}" | grep -oE "(blue|green)" | head -1)

            if [ "$CURRENT" = "blue" ]; then
              NEW="green"
            else
              NEW="blue"
            fi

            echo "Current active: ${CURRENT:-none}"
            echo "Deploying to: $NEW"

            # ========================================
            # 3. 새 이미지 Pull
            # ========================================
            echo "=== Step 3: Pull Docker Image ==="
            docker pull "$DOCKER_IMAGE"

            # ========================================
            # 4. 새 컨테이너 실행
            # ========================================
            echo "=== Step 4: Start New Container ==="

            # 기존 동일 이름 컨테이너 정리
            docker stop "whoreads-prod-$NEW" 2>/dev/null || true
            docker rm "whoreads-prod-$NEW" 2>/dev/null || true

            docker run -d \
              --name "whoreads-prod-$NEW" \
              --network "$NETWORK_NAME" \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DB_HOST="${{ secrets.DB_HOST }}" \
              -e DB_PORT="${{ secrets.DB_PORT }}" \
              -e DB_NAME="${{ secrets.DB_NAME_PROD }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e ALADIN_KEY="${{ secrets.ALADIN_KEY }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e FIREBASE_SECRET_BASE64="${{ secrets.FIREBASE_SECRET_JSON_BASE64 }}" \
              "$DOCKER_IMAGE"

            # ========================================
            # 5. 헬스체크
            # ========================================
            echo "=== Step 5: Health Check ==="
            echo "Waiting for application to start..."
            sleep 30

            # 컨테이너 내부에서 헬스체크
            HEALTH=$(docker exec "whoreads-prod-$NEW" curl -s http://localhost:8080/api/health)

            if echo "$HEALTH" | grep -q '"status"\s*:\s*"UP"'; then
              echo "Health check passed! (Status is UP)"

              # ========================================
              # 6. Nginx 설정 변경 및 리로드 (Docker 방식)
              # ========================================
              echo "=== Step 6: Update Nginx Configuration ==="

              # 롤백 함수 정의
              rollback_nginx() {
                echo "Rolling back nginx config and cleaning up new container..."
                if [ -f "$NGINX_CONF.bak" ]; then
                  cp "$NGINX_CONF.bak" "$NGINX_CONF"
                  echo "Restored nginx config from backup"
                fi
                docker stop "whoreads-prod-$NEW" 2>/dev/null || true
                docker rm "whoreads-prod-$NEW" 2>/dev/null || true
                exit 1
              }

              # 6-1. Nginx 설정 파일 존재 확인 (필수)
              if [ ! -f "$NGINX_CONF" ]; then
                echo "ERROR: Nginx config not found at $NGINX_CONF"
                docker stop "whoreads-prod-$NEW" 2>/dev/null || true
                docker rm "whoreads-prod-$NEW" 2>/dev/null || true
                exit 1
              fi

              # 6-2. Nginx 컨테이너 실행 확인 (필수)
              if ! docker ps --filter "name=$NGINX_CONTAINER" --format "{{.Names}}" | grep -q "$NGINX_CONTAINER"; then
                echo "ERROR: Nginx container '$NGINX_CONTAINER' not found or not running"
                docker stop "whoreads-prod-$NEW" 2>/dev/null || true
                docker rm "whoreads-prod-$NEW" 2>/dev/null || true
                exit 1
              fi

              # 6-3. 현재 설정 백업
              cp "$NGINX_CONF" "$NGINX_CONF.bak"
              echo "Backed up current nginx config"

              # 6-4. sed 치환
              sed -i "s/whoreads-prod-\(blue\|green\)/whoreads-prod-$NEW/g" "$NGINX_CONF"

              # 6-5. 변경 확인
              if ! grep -q "whoreads-prod-$NEW" "$NGINX_CONF"; then
                echo "ERROR: Failed to update Nginx config"
                rollback_nginx
              fi
              echo "Updated nginx config to point to: whoreads-prod-$NEW"

              # 6-6. nginx -t 설정 문법 검사
              if ! docker exec "$NGINX_CONTAINER" nginx -t 2>&1; then
                echo "ERROR: Nginx config validation failed"
                rollback_nginx
              fi
              echo "Nginx config validation passed"

              # 6-7. nginx -s reload
              if ! docker exec "$NGINX_CONTAINER" nginx -s reload 2>&1; then
                echo "ERROR: Nginx reload failed"
                rollback_nginx
              fi
              echo "Nginx reloaded successfully"

              # 백업 파일 정리
              rm -f "$NGINX_CONF.bak"

              # ========================================
              # 7. 이전 컨테이너 정리
              # ========================================
              echo "=== Step 7: Cleanup Old Container ==="

              if [ -n "$CURRENT" ]; then
                docker stop "whoreads-prod-$CURRENT" 2>/dev/null || true
                docker rm "whoreads-prod-$CURRENT" 2>/dev/null || true
                echo "Removed old container: whoreads-prod-$CURRENT"
              fi

              # 사용하지 않는 이미지 정리
              echo "Cleaning up unused images..."
              docker image prune -af --filter "until=24h" || true

              echo "=== Deployment Successful! ==="
            else
              echo "=== Health check FAILED! (Response: $HEALTH) Rolling back... ==="
              docker logs "whoreads-prod-$NEW" --tail 50
              docker stop "whoreads-prod-$NEW" 2>/dev/null || true
              docker rm "whoreads-prod-$NEW" 2>/dev/null || true
              exit 1
            fi
